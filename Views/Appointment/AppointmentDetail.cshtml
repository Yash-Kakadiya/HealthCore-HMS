@model DataRow
@using System.Data
@using HMS.Utils
@using System.Web
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    // --- Data Preparation ---
    var appointmentId = Model["AppointmentID"]?.ToString() ?? "0";
    // var enAppointmentId = UrlEncryptDecrypt.Encrypt(appointmentId);
    var enAppointmentId = HttpUtility.UrlEncode(UrlEncryptDecrypt.Encrypt(appointmentId));

    var patientName = Model["PatientName"]?.ToString() ?? "N/A";
    var doctorName = Model["DoctorName"]?.ToString() ?? "N/A";
    var status = Model["AppointmentStatus"]?.ToString() ?? "N/A";
    var userName = Model["UserName"]?.ToString() ?? "N/A";

    DateTime? appointmentDate = Model["AppointmentDate"] != DBNull.Value ? Convert.ToDateTime(Model["AppointmentDate"]) : (DateTime?)null;
    DateTime? created = Model["Created"] != DBNull.Value ? Convert.ToDateTime(Model["Created"]) : (DateTime?)null;
    DateTime? modified = Model["Modified"] != DBNull.Value ? Convert.ToDateTime(Model["Modified"]) : (DateTime?)null;

    ViewData["Title"] = $"Appointment for {patientName}";

    // --- Status Badge Logic ---
    string statusClass = status.ToLower() switch
    {
        "confirmed" => "status-confirmed",
        "completed" => "status-completed",
        "scheduled" => "status-scheduled",
        "cancelled" => "status-cancelled",
        _ => "status-pending"
    };
    string statusIcon = status.ToLower() switch
    {
        "confirmed" => "bi-check2-circle",
        "completed" => "bi-check2-all",
        "scheduled" => "bi-calendar-event",
        "cancelled" => "bi-x-circle",
        _ => "bi-hourglass-split"
    };
}

<!DOCTYPE html>
<html>
<head>
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .main-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: var(--glass-shadow);
            animation: fadeIn 0.5s ease-in-out;
        }

        .card-header-custom {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
        }

            .card-header-custom h2 {
                font-size: 2.25rem;
                font-weight: 700;
                color: var(--text-color-primary);
                text-shadow: 0 0 10px var(--neon-primary);
                margin: 0;
            }

            .card-header-custom .lead {
                color: var(--text-color-secondary);
                font-size: 1.1rem;
                margin-top: 0.25rem;
            }

        .status-badge {
            font-weight: 600;
            letter-spacing: 0.5px;
            padding: 0.6em 1.2em;
            font-size: 1rem;
            border-radius: 50px;
            border-width: 1px;
            border-style: solid;
        }

        .status-scheduled {
            color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.1);
            border-color: #0d6efd;
        }

        .status-completed {
            color: #198754;
            background-color: rgba(25, 135, 84, 0.1);
            border-color: #198754;
        }

        .status-cancelled {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
        }

        [data-theme="dark"] .status-scheduled {
            color: var(--neon-primary);
            background-color: rgba(10, 239, 255, 0.1);
            border-color: var(--neon-primary);
        }

        [data-theme="dark"] .status-completed {
            color: var(--neon-secondary);
            background-color: rgba(0, 255, 156, 0.1);
            border-color: var(--neon-secondary);
        }

        [data-theme="dark"] .status-cancelled {
            color: #ff7b72;
            background-color: rgba(255, 123, 114, 0.1);
            border-color: #ff7b72;
        }


        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

            .detail-item .icon {
                font-size: 1.75rem;
                color: var(--neon-primary);
                flex-shrink: 0;
                margin-top: 4px;
            }

            .detail-item .label {
                font-weight: 500;
                color: var(--text-color-secondary);
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }

            .detail-item .value {
                font-weight: 600;
                color: var(--text-color-primary);
                font-size: 1.1rem;
                word-break: break-all;
            }

        .card-footer-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.1);
            border-top: 1px solid var(--glass-border);
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

    </style>
    <link href="~/assets/css/detail.css" rel="stylesheet">

</head>
<body>
    <div class="container-fluid my-4 px-4">
        <div class="card main-card">
            <div class="card-header-custom">
                <div class="mb-3">
                    <span class="status-badge @statusClass"><i class="bi @statusIcon me-2"></i> @status</span>
                </div>
                <h2>Appointment with @patientName</h2>
                <p class="lead">Scheduled for @(appointmentDate.HasValue? appointmentDate.Value.ToString("dddd, dd MMMM yyyy 'at' hh:mm tt") : "N/A")</p>
            </div>

            <div class="card-body p-4 p-md-5">
                <div class="details-grid">
                    <div class="detail-item">
                        <i class="bi bi-person-gear icon"></i>
                        <div>
                            <div class="label">Consulting Doctor</div>
                            <div class="value">@doctorName</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="bi bi-cash-coin icon"></i>
                        <div>
                            <div class="label">Consultation Fee</div>
                            <div class="value">₹ @Model["TotalConsultedAmount"]</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="bi bi-body-text icon"></i>
                        <div>
                            <div class="label">Description / Reason</div>
                            <div class="value">@Model["Description"]</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="bi bi-chat-square-dots icon"></i>
                        <div>
                            <div class="label">Special Remarks</div>
                            <div class="value">@Model["SpecialRemarks"]</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="bi bi-person-check icon"></i>
                        <div>
                            <div class="label">Managed By</div>
                            <div class="value">@userName</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="bi bi-info-circle icon"></i>
                        <div>
                            <div class="label">Record Timestamps</div>
                            <div class="value" style="font-size: 0.9rem; color: var(--text-color-secondary);">
                                Created: @(created.HasValue? created.Value.ToString("dd/MM/yy, hh:mm tt") : "-") <br />
                                Modified: @(modified.HasValue? modified.Value.ToString("dd/MM/yy, hh:mm tt") : "Never")
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer-actions">
                <a class="btn btn-secondary" asp-controller="Appointment" asp-action="AppointmentList" title="Back to List">
                    <i class="bi bi-arrow-left-circle me-1"></i> Back to List
                </a>
                <a class="btn btn-primary" asp-controller="Appointment" asp-action="AppointmentAddEdit" asp-route-enAppointmentID="@enAppointmentId" title="Edit Appointment">
                    <i class="bi bi-pencil-square me-1"></i> Edit
                </a>
                <a class="btn btn-danger" href="javascript:void(0);" onclick="confirmDelete('@enAppointmentId')" title="Delete Appointment">
                    <i class="bi bi-trash me-1"></i> Delete
                </a>
            </div>
        </div>
    </div>


    @section Scripts {
        <script>
            // --- Razor to sessionStorage Bridge ---
            // This C# code runs on the server to move the message from TempData into a script tag
            // that places it in the browser's sessionStorage. This is the key to fixing the back-button bug.
            @{
                        var successMessage = TempData["SuccessMessage"]?.ToString();
                        var errorMessage = TempData["ErrorMessage"]?.ToString();

                        if (!string.IsNullOrEmpty(successMessage))
                        {
                                    <text>sessionStorage.setItem('hms_successMessage', '@Html.Raw(HttpUtility.JavaScriptStringEncode(successMessage))');</text>
                        }
                        if (!string.IsNullOrEmpty(errorMessage))
                        {
                                    <text>sessionStorage.setItem('hms_errorMessage', '@Html.Raw(HttpUtility.JavaScriptStringEncode(errorMessage))');</text>
                        }
            }

            // --- All frontend logic runs after the page is displayed ---
            document.addEventListener('DOMContentLoaded', function () {

                // --- SWEETALERT THEMED TOAST ---
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3500,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                        const popup = Swal.getPopup();
                        if(popup) {
                            popup.style.background = 'var(--glass-bg)';
                            popup.style.backdropFilter = 'blur(10px)';
                            popup.style.border = '1px solid var(--glass-border)';
                            popup.style.color = 'var(--text-color-primary)';
                        }
                    }
                });

                // --- MESSAGE HANDLING (from sessionStorage) ---
                // This checks sessionStorage, shows the message, and then immediately clears it.
                const successMsg = sessionStorage.getItem('hms_successMessage');
                if (successMsg) {
                    Toast.fire({ icon: 'success', title: successMsg });
                    sessionStorage.removeItem('hms_successMessage'); // Crucial: Clear after showing
                }

                const errorMsg = sessionStorage.getItem('hms_errorMessage');
                if (errorMsg) {
                    Swal.fire({
                        icon: 'error',
                        title: 'An Error Occurred',
                        text: errorMsg,
                    });
                    sessionStorage.removeItem('hms_errorMessage'); // Crucial: Clear after showing
                }

                // --- Initialize Bootstrap Tooltips ---
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });
            });

            // --- GLOBAL DELETE FUNCTION for this page ---
            function confirmDelete(appointmentId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this appointment!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("AppointmentDelete", "Appointment")?enAppointmentID=' + appointmentId;
                    }
                });
            }
        </script>
    }
</body>
</html>
