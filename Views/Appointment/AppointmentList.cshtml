@using HMS.Utils
@using System.Web
@model System.Data.DataTable
@{
    ViewData["Title"] = "Manage Appointments";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // --- Read current filter values from the query string for repopulating the form ---
    var filterStatus = Context.Request.Query["status"];
    var filterDateRange = Context.Request.Query["dateRange"];
    var filterDoctor = Context.Request.Query["doctorName"];
    var filterMinAmount = Context.Request.Query["minAmount"];
    var filterMaxAmount = Context.Request.Query["maxAmount"];
}
@* public int AppointmentID { get; set; }
    public int AppointmentID { get; set; }
    public int PatientID { get; set; }
    public DateTime AppointmentDate { get; set; }
    public string AppointmentStatus { get; set; }
    public string Description { get; set; }
    public string SpecialRemarks { get; set; }
    public DateTime Created { get; set; }
    public DateTime Modified { get; set; }
    public int UserID { get; set; }
    public decimal? TotalConsultedAmount { get; set; } *@
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link href="~/assets/css/list.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid my-4 px-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 page-header">
            <h2 class="m-0">Manage Appointments</h2>
            <div class="d-flex align-items-center mt-3 mt-md-0 action-bar">
                <button class="btn btn-danger" id="deleteSelectedBtn" style="display: none;">
                    <i class="bi bi-trash-fill me-1"></i> Selected
                </button>
                <div class="search-wrapper">
                    <i class="bi bi-search"></i>
                    <input type="text" id="appointmentSearch" class="form-control" placeholder="Search appointments...">
                </div>
                <div class="filter-wrapper">
                    <button class="btn btn-outline-secondary" id="filter-toggle-btn" data-bs-toggle="tooltip" title="Advanced Filters">
                        <i class="bi bi-funnel-fill"></i>
                    </button>
                    <div id="filter-popover">
                        <div class="filter-header">
                            <h5><i class="bi bi-funnel me-2"></i>Filters</h5>
                            <button type="button" class="btn-close" id="filter-close-btn" aria-label="Close"></button>
                        </div>
                        <form id="filter-form">
                            <div class="filter-group">
                                <label for="filterDateRange" class="form-label">Appointment Date Range</label>
                                <input type="text" name="dateRange" id="filterDateRange" class="form-control" placeholder="Select date range" value="@filterDateRange">
                            </div>
                            <div class="filter-group">
                                <label for="filterStatus" class="form-label">Status</label>
                                <select id="filterStatus" name="status" class="form-select">
                                    <option value="" selected="@(string.IsNullOrEmpty(filterStatus))">All Statuses 📋</option>
                                    <option value="pending" selected="@(filterStatus == "pending")">Pending ⏳</option>
                                    <option value="confirmed" selected="@(filterStatus == "confirmed")">Confirmed ✔️</option>
                                    <option value="cancelled" selected="@(filterStatus == "cancelled")">Cancelled ✖️</option>

                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="filterDoctor" class="form-label">Doctor Name</label>
                                <input type="text" name="doctorName" id="filterDoctor" class="form-control" placeholder="Enter doctor's name" value="@filterDoctor">
                            </div>
                            <div class="filter-group">
                                <label class="form-label">Consultation Amount Range</label>
                                <div class="amount-range">
                                    <input type="number" name="minAmount" id="filterMinAmount" class="form-control" placeholder="Min ₹" value="@filterMinAmount" min="0" step="0.01">
                                    <span>—</span>
                                    <input type="number" name="maxAmount" id="filterMaxAmount" class="form-control" placeholder="Max ₹" value="@filterMaxAmount" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="filter-buttons">
                                <button type="button" class="btn btn-secondary btn-sm" id="filter-reset-btn">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                                </button>
                                <button type="submit" class="btn btn-primary btn-sm" id="filter-apply-btn">
                                    <i class="bi bi-check2 me-1"></i>Apply Filters
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-download me-1"></i> Export
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end glass-effect" aria-labelledby="exportDropdown">
                        <li><a class="dropdown-item" asp-action="ExportAppointments" asp-route-exportType="excel"><i class="bi bi-file-earmark-excel me-2"></i>Export to Excel</a></li>
                        <li><a class="dropdown-item" asp-action="ExportAppointments" asp-route-exportType="pdf"><i class="bi bi-file-earmark-pdf me-2"></i>Export to PDF</a></li>
                        <li><a class="dropdown-item" asp-action="ExportAppointments" asp-route-exportType="csv"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Export to CSV</a></li>
                    </ul>
                </div>
                <a asp-action="AppointmentAddEdit" asp-controller="Appointment" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i> Add Appointment
                </a>
            </div>
        </div>
        <div class="card main-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="text-start">
                            <tr>
                                <th class="ps-4 text-center" style="width: 5%;"><input class="form-check-input" type="checkbox" id="selectAllCheckbox"></th>
                                <th style="width: 35%;">Patient's Name</th>
                                <th style="width: 20%;">Doctor's Name'</th>
                                <th class="text-center" style="width: 15%;">Status</th>
                                <th class="text-center pe-4" style="width: 25%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Rows.Count > 0)
                            {
                                var colors = new[] { "#0d6efd", "#6f42c1", "#198754", "#d63384", "#fd7e14", "#20c997" };
                                var colorIndex = 0;
                                foreach (System.Data.DataRow row in Model.Rows)
                                {
                                    colorIndex++;
                                    @* var appointmentId = @UrlEncryptDecrypt.Encrypt(row["AppointmentID"].ToString()); *@
                                    var appointmentId = HttpUtility.UrlEncode(UrlEncryptDecrypt.Encrypt(row["AppointmentID"].ToString()));

                                    var patientName = row["PatientName"].ToString();
                                    var avatarChar = string.IsNullOrEmpty(patientName) ? "" : patientName.Substring(0, 1).ToUpper();
                                    var avatarBg = colors[colorIndex % colors.Length];
                                    <tr class="clickable-row" style="animation-delay: @(colorIndex * 0.05)s" onclick="window.location.href='@Url.Action("AppointmentDetail", "Appointment", new { enAppointmentID = appointmentId })'">
                                        <td class="text-center ps-4" onclick="event.stopPropagation();">
                                            <input class="form-check-input appointment-checkbox" type="checkbox" value="@appointmentId">
                                        </td>

                                        <td class="ps-4">
                                            <div class="appointment-info">
                                                <div class="patient-avatar" style="background-color:@avatarBg">@avatarChar</div>
                                                <div>
                                                    <div class="appointment-patient">@row["PatientName"]</div>
                                                    <div class="appointment-date">@row["AppointmentDate"]</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="appointment-doctor">@row["DoctorName"]</div>
                                        </td>
                                        <td class="text-center">
                                            @if (row["AppointmentStatus"].ToString().ToLower() == "confirmed")
                                            {
                                                <span class="badge rounded-pill status-confirmed appointment-status">Confirmed</span>
                                            }
                                            else if (row["AppointmentStatus"].ToString().ToLower() == "cancelled")
                                            {
                                                <span class="badge rounded-pill status-cancelled appointment-status">Cancelled</span>
                                            }
                                            else
                                            {
                                                <span class="badge rounded-pill status-pending appointment-status">@row["AppointmentStatus"]</span>
                                            }
                                        </td>
                                        <td class="pe-4">
                                            <div class="action-buttons text-center" onclick="event.stopPropagation();">
                                                <a class="btn btn-sm btn-outline-primary btn-icon"
                                                   asp-controller="Appointment" asp-action="AppointmentAddEdit" asp-route-enAppointmentID="@appointmentId"
                                                   data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                                                    <i class="bi bi-pencil-fill"></i>
                                                </a>
                                                <a class="btn btn-sm btn-outline-danger btn-icon"
                                                   href="javascript:void(0);"
                                                   onclick="confirmDelete('@appointmentId')"
                                                   data-bs-toggle="tooltip" data-bs-placement="top" title="Delete">
                                                    <i class="bi bi-trash3-fill"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5">
                                        <div class="empty-state">
                                            <i class="bi bi-person-rolodex"></i>
                                            <h5>No Appointments Found</h5>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    @section Scripts {
        <script>
            // --- Razor to sessionStorage Bridge ---
            @{
                                        var successMessage = TempData["SuccessMessage"]?.ToString();
                                        var errorMessage = TempData["ErrorMessage"]?.ToString();
                                        if (!string.IsNullOrEmpty(successMessage))
                                        {
                                                                    <text>sessionStorage.setItem('hms_successMessage', '@Html.Raw(HttpUtility.JavaScriptStringEncode(successMessage))');</text>
                                        }
                                        if (!string.IsNullOrEmpty(errorMessage))
                                        {
                                                                    <text>sessionStorage.setItem('hms_errorMessage', '@Html.Raw(HttpUtility.JavaScriptStringEncode(errorMessage))');</text>
                                        }
            }

            document.addEventListener('DOMContentLoaded', function () {
                // --- SWEETALERT THEMED TOAST ---
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3500,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                        const popup = Swal.getPopup();
                        if(popup) {
                            popup.style.background = 'var(--glass-bg)';
                            popup.style.backdropFilter = 'blur(10px)';
                            popup.style.border = '1px solid var(--glass-border)';
                            popup.style.color = 'var(--text-color-primary)';
                        }
                    }
                });

                // --- MESSAGE HANDLING ---
                const successMsg = sessionStorage.getItem('hms_successMessage');
                if (successMsg) {
                    Toast.fire({ icon: 'success', title: successMsg });
                    sessionStorage.removeItem('hms_successMessage');
                }
                const errorMsg = sessionStorage.getItem('hms_errorMessage');
                if (errorMsg) {
                    Swal.fire({
                        icon: 'error',
                        title: 'An Error Occurred',
                        text: errorMsg,
                    });
                    sessionStorage.removeItem('hms_errorMessage');
                }

                // --- TOOLTIPS ---
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });

                            // --- SEARCH FUNCTIONALITY ---
            document.getElementById('appointmentSearch').addEventListener('keyup', function() {
                let filter = this.value.toLowerCase().trim();
                let rows = document.querySelectorAll('tbody tr.clickable-row');
                let noResults = true; // Flag to check if no results are visible

                rows.forEach(row => {
                    let name = row.querySelector('.appointment-patient').textContent.toLowerCase().trim();
                    let date = row.querySelector('.appointment-date').textContent.toLowerCase().trim();
                    let doctor = row.querySelector('.appointment-doctor').textContent.toLowerCase().trim();
                    let status = row.querySelector('.appointment-status').textContent.toLowerCase().trim();

                    if (name.includes(filter) || date.includes(filter) || doctor.includes(filter) || status.includes(filter)) {
                        row.style.display = '';
                        noResults = false; // If a row matches the filter, set the flag to false
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Check if no results found, then show empty state row
                let emptyStateRow = document.querySelector('.empty-state-row');
                if (noResults) {
                    if (!emptyStateRow) {
                        let emptyStateHTML = `
                            <tr class="empty-state-row">
                                <td colspan="5">
                                    <div class="empty-state">
                                        <i class="bi bi-person-rolodex"></i>
                                        <h5>No Appointments Found</h5>
                                    </div>
                                </td>
                            </tr>`;
                        document.querySelector('tbody').insertAdjacentHTML('beforeend', emptyStateHTML);
                    }
                } else {
                    // If there are results, remove the empty state row if it exists
                    if (emptyStateRow) {
                        emptyStateRow.remove();
                    }
                }
            });


                // --- CHECKBOX FUNCTIONALITY ---
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const appointmentCheckboxes = document.querySelectorAll('.appointment-checkbox');
                const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

                function toggleDeleteButton() {
                    const checkedCount = document.querySelectorAll('.appointment-checkbox:checked').length;
                    deleteSelectedBtn.style.display = checkedCount > 0 ? 'inline-flex' : 'none';
                }

                selectAllCheckbox.addEventListener('change', (e) => {
                    appointmentCheckboxes.forEach(checkbox => checkbox.checked = e.target.checked);
                    toggleDeleteButton();
                });

                appointmentCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const allChecked = [...appointmentCheckboxes].every(c => c.checked);
                        const noneChecked = [...appointmentCheckboxes].every(c => !c.checked);
                        if(allChecked) { selectAllCheckbox.checked = true; selectAllCheckbox.indeterminate = false; }
                        else if(noneChecked) { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = false; }
                        else { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = true; }
                        toggleDeleteButton();
                    });
                });

                deleteSelectedBtn.addEventListener('click', () => {
                    const selectedIds = [...appointmentCheckboxes].filter(c => c.checked).map(c => c.value);
                    Swal.fire({
                        title: 'Delete Selected Appointments?',
                        text: `You are about to delete ${selectedIds.length} appointments. This action cannot be undone.`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, delete them!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = '@Url.Action("DeleteSelectedAppointments", "Appointment")';
                            selectedIds.forEach(id => {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = 'selectedAppointmentIds';
                                input.value = id;
                                form.appendChild(input);
                            });
                            document.body.appendChild(form);
                            form.submit();
                        }
                    });
                });

                // --- FILTER FUNCTIONALITY ---
                const filterToggleBtn = document.getElementById('filter-toggle-btn');
                const filterPopover = document.getElementById('filter-popover');
                const filterCloseBtn = document.getElementById('filter-close-btn');
                const filterForm = document.getElementById('filter-form');
                const filterResetBtn = document.getElementById('filter-reset-btn');

                // Initialize Flatpickr for date range
                const datePicker = flatpickr("#filterDateRange", {
                    mode: "range",
                    dateFormat: "Y-m-d",
                    altInput: true,
                    altFormat: "M j, Y",
                    allowInput: true,
                    clickOpens: true
                });

                // Check if filters are active and update button appearance
                function updateFilterButtonState() {
                    const hasFilters = '@filterStatus' || '@filterDateRange' || '@filterDoctor' || '@filterMinAmount' || '@filterMaxAmount';
                    if (hasFilters) {
                        filterToggleBtn.classList.add('btn-filter-active');
                    } else {
                        filterToggleBtn.classList.remove('btn-filter-active');
                    }
                }
                updateFilterButtonState();

                // Toggle filter popover
                filterToggleBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const isVisible = filterPopover.style.display === 'block';
                    filterPopover.style.display = isVisible ? 'none' : 'block';
                });

                // Close filter popover
                filterCloseBtn.addEventListener('click', () => {
                    filterPopover.style.display = 'none';
                });

                // Close popover when clicking outside
                document.addEventListener('click', function(event) {
                    if (!filterPopover.contains(event.target) && !filterToggleBtn.contains(event.target)) {
                        filterPopover.style.display = 'none';
                    }
                });

                // Prevent popover from closing when clicking inside
                filterPopover.addEventListener('click', function(event) {
                    event.stopPropagation();
                });

                // Handle filter form submission
                filterForm.addEventListener('submit', function(event) {
                    event.preventDefault();

                    const formData = new FormData(filterForm);
                    const params = new URLSearchParams();

                    // Build query string from form data, ignoring empty fields
                    for (const [key, value] of formData.entries()) {
                        if (value && value.trim()) {
                            params.append(key, value.trim());
                        }
                    }

                    // Navigate to the filtered results
                    const baseUrl = '@Url.Action("AppointmentList", "Appointment")';
                    const queryString = params.toString();
                    window.location.href = queryString ? `${baseUrl}?${queryString}` : baseUrl;
                });

                // Reset filters
                filterResetBtn.addEventListener('click', () => {
                    // Clear the date picker
                    if (datePicker) {
                        datePicker.clear();
                    }

                    // Reset form fields
                    filterForm.reset();

                    // Navigate to base page without filters
                    window.location.href = '@Url.Action("AppointmentList", "Appointment")';
                });

                // Auto-apply filters on input change for better UX (optional)
                const autoFilterInputs = filterForm.querySelectorAll('select[name="status"]');
                autoFilterInputs.forEach(input => {
                    input.addEventListener('change', () => {
                        // Optional: Auto-submit form on status change
                        // filterForm.dispatchEvent(new Event('submit'));
                    });
                });
            });

            // --- GLOBAL DELETE FUNCTION ---
            function confirmDelete(appointmentId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("AppointmentDelete", "Appointment")?enAppointmentID=' + appointmentId;
                    }
                });
            }
        </script>
    }
</body>
</html>