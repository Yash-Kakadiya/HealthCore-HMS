@model DataRow
@using System.Data
@using HMS.Utils
@using System.Web
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    // --- Data Preparation ---
    var doctorId = Model["DoctorID"]?.ToString() ?? "0";
    // var enDoctorId = UrlEncryptDecrypt.Encrypt(doctorId);
    var enDoctorId = HttpUtility.UrlEncode(UrlEncryptDecrypt.Encrypt(doctorId));

    var doctorName = Model["DoctorName"]?.ToString() ?? "N/A";
    var specialization = Model["Specialization"]?.ToString() ?? "Not specified";
    // Assuming the User's profile image might be relevant for the doctor. If doctors have their own, change "ProfileImage" to the correct column name.
    var profileImage = Model.Table.Columns.Contains("ProfileImage") ? Model["ProfileImage"]?.ToString() : string.Empty;
    var avatarChar = string.IsNullOrEmpty(doctorName) ? "D" : doctorName.Substring(0, 1).ToUpper();
    bool isActive = Model["IsActive"] != DBNull.Value && Convert.ToBoolean(Model["IsActive"]);
    DateTime? created = Model["Created"] != DBNull.Value ? Convert.ToDateTime(Model["Created"]) : (DateTime?)null;
    DateTime? modified = Model["Modified"] != DBNull.Value ? Convert.ToDateTime(Model["Modified"]) : (DateTime?)null;
    ViewData["Title"] = $"Dr. {doctorName} - Details";
}

<!DOCTYPE html>
<html>
<head>
    <title>@ViewData["Title"]</title>
    <!-- SweetAlert2 is required for the delete confirmation -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>

        /* --- Refined Styles for a Unified Detail View --- */
        .profile .main-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: var(--glass-shadow);
            animation: fadeIn 0.5s ease-in-out;
        }

        .profile .profile-header {
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .profile .profile-image-wrapper {
            position: relative;
        }

        .profile .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--neon-primary);
            box-shadow: 0 0 15px var(--neon-primary), 0 0 25px rgba(10, 239, 255, 0.5);
            object-fit: cover;
            animation: fadeIn 0.6s 0.1s ease-in-out backwards;
        }

        .profile .profile-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color-primary);
            text-shadow: 0 0 8px var(--neon-primary);
            animation: fadeIn 0.6s 0.2s ease-in-out backwards;
        }

        .profile .status-badge {
            font-weight: 600;
            letter-spacing: 0.5px;
            padding: 0.5em 1em;
            font-size: 0.9rem;
            animation: fadeIn 0.6s 0.3s ease-in-out backwards;
            border-radius: 20px;
            border-width: 1px;
            border-style: solid;
        }

        .status-active {
            background-color: rgba(0, 255, 156, 0.15);
            color: var(--neon-secondary);
            border-color: var(--neon-secondary);
        }

        .status-inactive {
            background-color: rgba(139, 148, 158, 0.15);
            color: var(--text-color-secondary);
            border-color: var(--text-color-secondary);
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

            .detail-item .icon {
                font-size: 1.5rem;
                color: var(--neon-primary);
                margin-top: 5px;
                flex-shrink: 0;
            }

            .detail-item .label {
                font-weight: 500;
                color: var(--text-color-secondary);
                font-size: 0.9rem;
                margin-bottom: 0.25rem;
            }

            .detail-item .value {
                font-weight: 600;
                color: var(--text-color-primary);
                font-size: 1rem;
                word-break: break-all;
            }

        .btn-copy { /* Style for copy button */
        }

        .card-footer-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: rgba(0,0,0,0.1);
            border-top: 1px solid var(--glass-border);
        }


        .btn-copy {
            background: transparent;
            border: 1px solid var(--glass-border);
            color: var(--text-color-secondary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed);
        }

            .btn-copy:hover {
                border-color: var(--neon-primary);
                color: var(--neon-primary);
                transform: scale(1.1);
            }


        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <link href="~/assets/css/detail.css" rel="stylesheet">

</head>
<body>
    <div class="container-fluid my-4 px-4">
        <section class="profile">
            <div class="card main-card">
                <div class="card-body p-4 p-md-5">

                    <!-- --- Refined Profile Header --- -->
                    <div class="profile-header d-flex flex-column align-items-center text-center">
                        <div class="profile-image-wrapper mb-3">
                            @if (!string.IsNullOrEmpty(profileImage))
                            {
                                <img src="~/@Url.Content(profileImage)" alt="@doctorName" class="profile-image" />
                            }
                            else
                            {
                                <div class="profile-image d-flex align-items-center justify-content-center" style="background-color: var(--neon-primary); font-size: 3rem; color: #fff;">
                                    @avatarChar
                                </div>
                            }
                        </div>
                        <h2 class="mb-1">@doctorName</h2>
                        <p class="h5 text-muted mb-3">@specialization</p>
                        @if (isActive)
                        {
                            <span class="status-badge status-active"><i class="bi bi-check-circle-fill me-1"></i> Active</span>
                        }
                        else
                        {
                            <span class="status-badge status-inactive"><i class="bi bi-x-circle-fill me-1"></i> Inactive</span>
                        }
                    </div>

                    <!-- --- Unified & Centered Details Section --- -->
                    <div class="details-wrapper">
                        <!-- Row 1: Contact Info -->
                        <div class="row justify-content-center g-4 mb-4">
                            <div class="col-lg-6">
                                <div class="detail-item">
                                    <i class="bi bi-envelope-at icon"></i>
                                    <div>
                                        <div class="label">Email Address</div>
                                        <div class="value-wrapper">
                                            <span id="email-text" class="value">@Model["Email"]</span>
                                            <button class="btn-copy ms-2" title="Copy Email" onclick="copyToClipboard('email-text', this)">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="detail-item">
                                    <i class="bi bi-telephone icon"></i>
                                    <div>
                                        <div class="label">Phone Number</div>
                                        <div class="value-wrapper">
                                            <span id="phone-text" class="value">@Model["Phone"]</span>
                                            <button class="btn-copy ms-2" title="Copy Phone" onclick="copyToClipboard('phone-text', this)">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Professional Details -->
                        <div class="row justify-content-center g-4 mb-4">
                            <div class="col-lg-6">
                                <div class="detail-item">
                                    <i class="bi bi-mortarboard-fill icon"></i>
                                    <div>
                                        <div class="label">Qualification</div>
                                        <div class="value">@Model["Qualification"]</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="detail-item">
                                    <i class="bi bi-person-check-fill icon"></i>
                                    <div>
                                        <div class="label">Linked User Account</div>
                                        <div class="value">@Model["UserName"]</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 3: Metadata -->
                        <div class="row justify-content-center g-4">
                            <div class="col-lg-6">
                                <div class="detail-item">
                                    <i class="bi bi-calendar-plus icon"></i>
                                    <div>
                                        <div class="label">Profile Created</div>
                                        <div class="value">@(created.HasValue? created.Value.ToString("dd MMM yyyy, hh:mm tt") : "-")</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="detail-item">
                                    <i class="bi bi-calendar-check icon"></i>
                                    <div>
                                        <div class="label">Last Modified</div>
                                        <div class="value">@(modified.HasValue? modified.Value.ToString("dd MMM yyyy, hh:mm tt") : "Never")</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- --- Action Buttons Footer --- -->
                <div class="card-footer-actions">
                    <a class="btn btn-secondary" asp-controller="Doctor" asp-action="DoctorList" title="Back to List">
                        <i class="bi bi-arrow-left-circle me-1"></i> Back to List
                    </a>
                    <a class="btn btn-primary" asp-controller="Doctor" asp-action="DoctorAddEdit" asp-route-enDoctorID="@enDoctorId" title="Edit Doctor">
                        <i class="bi bi-pencil-square me-1"></i> Edit
                    </a>
                    <a class="btn btn-danger" href="javascript:void(0);" onclick="confirmDelete('@enDoctorId')" title="Delete Doctor">
                        <i class="bi bi-trash me-1"></i> Delete
                    </a>
                </div>
            </div>
        </section>
    </div>

    @section Scripts {
        <script>
            // This Razor block moves TempData to sessionStorage to prevent the back-button bug.
            @{
                            var successMessage = TempData["SuccessMessage"]?.ToString();
                            var errorMessage = TempData["ErrorMessage"]?.ToString();
                            if (!string.IsNullOrEmpty(successMessage))
                            {
                                            <text>sessionStorage.setItem('hms_successMessage', '@Html.Raw(HttpUtility.JavaScriptStringEncode(successMessage))');</text>
                            }
                            if (!string.IsNullOrEmpty(errorMessage))
                            {
                                            <text>sessionStorage.setItem('hms_errorMessage', '@Html.Raw(HttpUtility.JavaScriptStringEncode(errorMessage))');</text>
                            }
            }

            document.addEventListener('DOMContentLoaded', function () {
                // --- SWEETALERT & MESSAGE HANDLING ---
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3500, timerProgressBar: true, didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); const popup = Swal.getPopup(); if(popup){ popup.style.background='var(--glass-bg)'; popup.style.backdropFilter='blur(10px)'; popup.style.border='1px solid var(--glass-border)'; popup.style.color='var(--text-color-primary)'; } } });
                const successMsg = sessionStorage.getItem('hms_successMessage'); if (successMsg) { Toast.fire({ icon: 'success', title: successMsg }); sessionStorage.removeItem('hms_successMessage'); }
                const errorMsg = sessionStorage.getItem('hms_errorMessage'); if (errorMsg) { Swal.fire({ icon: 'error', title: 'An Error Occurred', text: errorMsg }); sessionStorage.removeItem('hms_errorMessage'); }

                // --- INITIALIZE TOOLTIPS ---
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });
            });

            // --- GLOBAL FUNCTIONS ---
            function copyToClipboard(elementId, buttonElement) {
                const textToCopy = document.getElementById(elementId).innerText;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalIcon = buttonElement.innerHTML;
                    buttonElement.innerHTML = '<i class="bi bi-clipboard-check-fill text-success"></i>';
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                    Toast.fire({ icon: 'success', title: 'Copied!' });
                    setTimeout(() => { buttonElement.innerHTML = originalIcon; }, 2000);
                }).catch(err => { console.error('Failed to copy text.', err); });
            }

            function confirmDelete(doctorId) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("DoctorDelete", "Doctor")?enDoctorID=' + doctorId;
                    }
                });
            }
        </script>
    }
</body>
</html>
