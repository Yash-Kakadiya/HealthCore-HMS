@using HMS.Utils
@using Microsoft.AspNetCore.Http
@using System.Web
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>HealthCore - Hospital Management System</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="~/assets/img/main-logo.png" rel="icon">
    <link href="~/assets/img/main-logo.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="~/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="~/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <link href="~/assets/vendor/quill/quill.snow.css" rel="stylesheet">
    <link href="~/assets/vendor/quill/quill.bubble.css" rel="stylesheet">
    <link href="~/assets/vendor/remixicon/remixicon.css" rel="stylesheet">
    <link href="~/assets/vendor/simple-datatables/style.css" rel="stylesheet">

    <!-- Favicons -->
    <link href="~/assets/img/favicon.png" rel="icon">
    <link href="~/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link href="~/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

    <!-- Font Awesome for more icon choices -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    @RenderSection("HeadScripts", required: false)
    <!-- Template Main CSS File -->
    <link href="~/assets/css/style.css" rel="stylesheet">
    @* ===== START: REVISED CHAT STYLE BLOCK ===== *@
    <style>


        .chat-window {
            position: fixed;
            top: 70px;
            right: 25px;
            width: 450px;
            height: 550px;
            /* Using variables from your style.css */
            background-color: var(--bg-color);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            /* --- FIX: Increased z-index --- */
            z-index: 100001; /* Higher than the fab */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
        }

        @@keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-header {
            padding: 15px;
            /* Using your glass effect for the header */
            background-color: var(--glass-bg);
            color: var(--text-color-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--glass-border);
        }

            .chat-header i {
                margin-right: 10px;
            }

        .chat-close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.5;
        }

            .chat-close:hover {
                opacity: 1;
            }

        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            list-style: none;
            margin: 0;
        }

            .chat-messages li {
                max-width: 85%;
                padding: 8px 12px;
                border-radius: 18px;
                margin-bottom: 10px;
                word-wrap: break-word;
            }

                /* Message from others */
                .chat-messages li.message-other {
                    /* Using your glass border as the background */
                    background-color: var(--glass-border);
                    color: var(--text-color-primary);
                    border-bottom-left-radius: 4px;
                    align-self: flex-start;
                }

                /* Message from me */
                .chat-messages li.message-me {
                    background-color: var(--neon-primary);
                    color: #010409; /* Dark text for the light neon color */
                    border-bottom-right-radius: 4px;
                    margin-left: auto; /* Aligns to the right */
                }

        /* Adjust text color for dark theme */
        [data-theme="dark"] .chat-messages li.message-me {
            color: #010409;
        }
        /* Adjust text color for light theme */
        [data-theme="light"] .chat-messages li.message-me {
            color: white;
        }


        .message-user {
            font-size: 0.75rem;
            font-weight: 600;
            display: block;
            margin-bottom: 3px;
            opacity: 0.8;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            display: block;
            text-align: right;
            margin-top: 4px;
        }

        /* System join/leave messages */
        .chat-messages li.message-system {
            background: none;
            font-style: italic;
            font-size: 0.8rem;
            text-align: center;
            color: var(--text-color-secondary);
            width: 100%;
            max-width: 100%;
        }

        .chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid var(--glass-border);
        }

        #chat-message-input {
            flex-grow: 1;
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 8px 15px;
            margin-right: 10px;
            background: var(--bg-color);
            color: var(--text-color-primary);
        }

        #chat-send-button {
            border: none;
            background: var(--neon-primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
        }

        .chat-header {
            /* This ensures the left/right parts are split */
            justify-content: space-between;
        }

        .chat-header-icon {
            color: var(--text-color-primary);
            opacity: 0.7;
            margin-right: 15px;
            font-size: 1.1rem;
            text-decoration: none;
        }

            .chat-header-icon:hover {
                opacity: 1;
            }

        .chat-body-wrapper {
            display: flex;
            flex-grow: 1; /* Makes this section fill the space */
            overflow: hidden; /* Prevents double scrollbars */
            transition: all 0.3s ease;
        }

        /* Update chat-messages to be flexible */
        #chat-messages {
            flex-grow: 1;
            width: 100%;
            transition: width 0.3s ease;
        }

            /* This class will be added by JS */
            #chat-messages.showing-users {
                width: calc(100% - 140px); /* Shrink messages when user list is open */
            }

        .online-users-list {
            width: 140px;
            flex-shrink: 0; /* Prevents list from shrinking */
            background: var(--glass-bg);
            border-left: 1px solid var(--glass-border);
            overflow-y: auto;
            list-style: none;
            padding: 10px;
            margin: 0;
            font-size: 0.9rem;
        }

            .online-users-list li {
                padding: 5px 2px;
                color: var(--text-color-primary);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

                .online-users-list li.is-you {
                    font-weight: 600;
                    color: var(--neon-primary);
                }

        .typing-indicator {
            padding: 5px 15px;
            font-size: 0.85rem;
            font-style: italic;
            color: var(--text-color-secondary);
            height: 24px; /* Fix height to prevent layout jump */
            transition: all 0.2s ease;
        }

        #chat-header-icon {
            position: relative;
        }

        .chat-badge {
            position: absolute;
            top: -5px; /* Position it over the icon */
            right: -10px; /* Position it over the icon */
            width: 18px;
            height: 18px;
            background-color: #dc3545; /* Bootstrap danger red */
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-color); /* Match page background */
        }
    </style>
    @* ===== END: REVISED CHAT STYLE BLOCK ===== *@
</head>
<body>

    <!-- Particle background container -->
    <div id="particles-js"></div>

    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center" data-aos="fade-down">

        <div class="d-flex align-items-center justify-content-start">
            <a asp-controller="Dashboard" asp-action="Index" class="logo d-flex align-items-center" >
                <img src="~/assets/img/main-logo.png" alt="">
                <span class="d-none d-lg-block">HeathCore</span>
            </a>
            <i class="bi bi-list toggle-sidebar-btn"></i>
        </div><!-- End Logo -->
        @* <div class="search-bar">
            <form class="search-form d-flex align-items-center" method="POST" action="#">
                <input type="text" name="query" placeholder="Search" title="Enter search keyword">
                <button type="submit" title="Search"><i class="bi bi-search"></i></button>
            </form>
        </div><!-- End Search Bar --> *@

        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">

                <!-- Theme Toggle Switch -->
                <li class="nav-item me-3">
                    <div class="theme-switch-wrapper">
                        <label class="theme-switch" for="theme-toggle">
                            <input type="checkbox" id="theme-toggle" />
                            <div class="slider round">
                                <i class="bi bi-sun-fill light-icon"></i>
                                <i class="bi bi-moon-stars-fill dark-icon"></i>
                            </div>
                        </label>
                    </div>
                </li>

                @* <li class="nav-item d-block d-lg-none">
                    <a class="nav-link nav-icon search-bar-toggle " href="#">
                        <i class="bi bi-search"></i>
                    </a>
                </li><!-- End Search Icon-->

                <li class="nav-item dropdown">
                    <a class="nav-link nav-icon" href="#" data-bs-toggle="dropdown">
                        <i class="bi bi-bell"></i>
                        <span class="badge bg-primary badge-number">4</span>
                    </a><!-- End Notification Icon -->
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow notifications">
                        <!-- Original Notification Items -->
                    </ul>
                </li><!-- End Notification Nav -->*@

                <li class="nav-item ">
                    <a class="nav-link nav-icon" href="#" id="chat-header-icon" title="Group Chat">
                        <i class="bi bi-chat-left-text"></i>
                        <span id="chat-badge" class="chat-badge" style="display: none;">0</span>
                    </a>
                </li>

                <li class="nav-item dropdown pe-3" style="background-image:transparent">
                    <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                        @{
                            var profileImagePath = Context.Session.GetString("ProfileImage");
                        }
                        <img src="~/@Url.Content(profileImagePath)" alt="¥A$#" class="rounded-circle" style="height:36px; width:36px">
                        <span class="d-none d-md-block dropdown-toggle ps-2">
                            <b>@Context.Session.GetString("UserName")</b>
                        </span>
                    </a><!-- End Profile Image Icon -->
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                        <!-- Original Profile Dropdown Items -->
                        <li class="dropdown-header">
                            <h6>@Context.Session.GetString("UserName")</h6>
                            <span>Software Engineer</span>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item d-flex align-items-center" href="#"><i class="bi bi-person"></i><span>My Profile</span></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item d-flex align-items-center" href="#"><i class="bi bi-gear"></i><span>Account Settings</span></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item d-flex align-items-center" href="#"><i class="bi bi-question-circle"></i><span>Need Help?</span></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item d-flex align-items-center" asp-controller="User" asp-action="UserLogout"><i class="bi bi-box-arrow-right"></i><span>Log Out</span></a></li>

                    </ul>
                </li><!-- End Profile Nav -->

            </ul>
        </nav><!-- End Icons Navigation -->

    </header><!-- End Header -->
    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar" data-aos="fade-right">
        <ul class="sidebar-nav" id="sidebar-nav">
            <!-- ALL ORIGINAL SIDEBAR CONTENT REMAINS HERE -->
            <li class="nav-item">
                <a class="nav-link " asp-controller="Dashboard" asp-action="Index">
                    <i class="bi bi-grid"></i>
                    <span>Dashboard</span>
                </a>
            </li>


            <li class="nav-item">
                <a class="nav-link " asp-controller="Patient" asp-action="PatientList">
                    <i class="bi bi-person-wheelchair"></i><span>Patients</span>
                </a>
            </li><!-- End Patients Nav -->
            <li class="nav-item">
                <a class="nav-link " asp-controller="Appointment" asp-action="AppointmentList">
                    <i class="bi bi-ui-checks-grid"></i><span>Appointments</span>
                </a>

            </li><!-- End Appoinments Nav -->
            <li class="nav-item">
                <a class="nav-link " asp-controller="Doctor" asp-action="DoctorList">
                    <i class="bi bi-person-gear"></i><span>Doctors</span>
                </a>
            </li><!-- End Doctors Nav -->
            <li class="nav-item">
                <a class="nav-link " asp-controller="Department" asp-action="DepartmentList">
                    <i class="bi bi-columns-gap"></i><span>Departments</span>
                </a>
            </li><!-- End Departments Nav -->

            <li class="nav-item">
                <a class="nav-link " asp-controller="DoctorDepartment" asp-action="DoctorDepartmentList">
                    <i class="bi bi-bar-chart"></i><span>Doctor X Department</span>
                </a>
            </li><!-- End DoctorDepartments Nav -->

            <li class="nav-item">
                <a class="nav-link " asp-controller="User" asp-action="UserList">
                    <i class="bi bi-person-lines-fill"></i><span>Users(Admins)</span>
                </a>
            </li><!-- End Users Nav -->

            <li class="nav-item">
                @{
                    var id = Context.Session.GetString("UserID");
                    var userId = HttpUtility.UrlEncode(UrlEncryptDecrypt.Encrypt(id.ToString()));

                }
                <a class="nav-link collapsed" asp-controller="User" asp-action="UserDetail" asp-route-enUserID="@userId">
                    <i class="bi bi-person"></i>
                    <span> My Profile</span>
                </a>
            </li><!-- End Profile Page Nav -->
            @* 
            <li class="nav-item">
                <a class="nav-link " href="pages-faq.html">
                    <i class="bi bi-question-circle"></i>
                    <span>F.A.Q</span>
                </a>
            </li><!-- End F.A.Q Page Nav -->*@

            <li class="nav-item">
                <a class="nav-link " href="https://github.com/Yash-Kakadiya">
                    <i class="bi bi-github"></i>
                    <span>Contact</span>
                </a>
            </li><!-- End Contact Page Nav -->
 

            <li class="nav-item">
                <a class="nav-link " asp-controller="User" asp-action="UserLogout">
                    <i class="bi bi-box-arrow-left"></i>
                    <span>Log out</span>
                </a>
            </li><!-- End Logout Page Nav -->
        </ul>
    </aside><!-- End Sidebar-->

    <main id="main" class="main" data-aos="fade-up" data-aos-delay="200">
        <section class="section dashboard">
            @RenderBody()
        </section>
    </main><!-- End #main -->
    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
        <div class="copyright">
            &copy; Copyright <strong><span>¥&commat;$#</span></strong>. !All Rights Reserved🤫
        </div>
        <div class="credits">
            Designed by <a href="https://github.com/Yash-Kakadiya">The Yash Kakadiya & Team🙃</a>
        </div>
    </footer><!-- End Footer -->

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get current path
            const currentPath = window.location.pathname.toLowerCase();

            // Extract controller and action from path
            const pathParts = currentPath.split('/').filter(part => part !== '');
            const currentController = pathParts[0] || '';
            const currentAction = pathParts[1] || '';

            // Get the encrypted user ID from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const enUserID = urlParams.get('enUserID') || urlParams.get('enuserid');

            // Use the existing userId variable that was already defined above
            const currentUserEncryptedID = "@userId";

            // Get all nav links
            const navLinks = document.querySelectorAll('.sidebar-nav .nav-link');

            navLinks.forEach((link) => {
                const href = link.getAttribute('href');

                if (href) {
                    // Split href into path and query string
                    const [path, query] = href.toLowerCase().split('?');

                    // Extract controller and action from path only
                    const hrefParts = path.split('/').filter(part => part !== '');
                    const linkController = hrefParts[0] || '';
                    const linkAction = hrefParts[1] || '';

                    let shouldHighlight = false;

                    // Special handling for User controller items
                    if (currentController === 'user' && linkController === 'user') {
                        // Check if we're on the Profile page (UserDetail with current user's ID)
                        const isOnProfilePage = (currentAction === 'userdetail' &&
                                                enUserID &&
                                                currentUserEncryptedID &&
                                                enUserID === currentUserEncryptedID);

                        // For UserList - highlight for all User actions EXCEPT Profile and Logout
                        if (linkAction === 'userlist') {
                            shouldHighlight = !isOnProfilePage && (currentAction !== 'userlogout');
                        }
                        // For UserDetail (Profile) - highlight only when on own profile
                        else if (linkAction === 'userdetail') {
                            shouldHighlight = isOnProfilePage;
                        }
                        // For UserLogout - never highlight
                        else if (linkAction === 'userlogout') {
                            shouldHighlight = false;
                        }
                    }
                    // For all other controllers, just match the controller
                    else if (linkController === currentController && currentController !== '') {
                        shouldHighlight = true;
                    }

                    // Apply or remove collapsed class
                    if (shouldHighlight) {
                        link.classList.remove('collapsed');
                    } else {
                        if (!link.classList.contains('collapsed')) {
                            link.classList.add('collapsed');
                        }
                    }
                }
            });
        });
    </script>
    <!-- Vendor JS Files -->
    <script src="~/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Animation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- Particle.js for background effect -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>


    <!-- Template Main JS File -->
    <script src="~/assets/js/main.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/notification-handler.js" asp-append-version="true"></script>

    <!-- Custom Scripts for Theme and Animations -->
    <script>
        @{
                                                                        var successMessage = TempData["SuccessMessage"]?.ToString();
                                                                        var errorMessage = TempData["ErrorMessage"]?.ToString();
                                                                        var successType = TempData["SuccessType"]?.ToString();

                                                                        if (!string.IsNullOrEmpty(successMessage))
                                                                        {
                                                                                                                                        <text>sessionStorage.setItem('hms_successMessage', '@Html.Raw(HttpUtility.JavaScriptStringEncode(successMessage))');</text>
                                                                        }
                                                                        if (!string.IsNullOrEmpty(successType))
                                                                        {
                                                                                                                                        <text>sessionStorage.setItem('hms_successType', '@Html.Raw(HttpUtility.JavaScriptStringEncode(successType))');</text>
                                                                        }
                                                                        if (!string.IsNullOrEmpty(errorMessage))
                                                                        {
                                                                                                                                        <text>sessionStorage.setItem('hms_errorMessage', '@Html.Raw(HttpUtility.JavaScriptStringEncode(errorMessage))');</text>
                                                                        }
        }
        document.addEventListener('DOMContentLoaded', function () {
            'use strict';

            AOS.init({ duration: 800, once: true });

            // --- Theme Toggle Logic ---
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.body;
            const applyTheme = (theme) => {
                body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                themeToggle.checked = (theme === 'dark');
                // We will re-initialize particles.js on theme change to update colors
                if (window.pJSDom && window.pJSDom[0]) {
                    window.pJSDom[0].pJS.fn.vendors.destroypJS();
                    window.pJSDom = [];
                }
                initParticles();
            };
            themeToggle.addEventListener('change', () => applyTheme(themeToggle.checked ? 'dark' : 'light'));
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);

            // --- ENHANCED particles.js Configuration ---
            function initParticles() {
                const isDarkMode = document.body.getAttribute('data-theme') === 'dark';

                // Define color palettes for both themes
                // const lightThemeColors = ["#0d6efd", "#0dcaf0", "#198754"]; Blue, Teal, Green
                // const darkThemeColors = ["#0aefff", "#00ff9c", "#39d353"]; Neon Blue, Neon Green

                const lightThemeColors = ["#0d6efd", "#0dcaf0", "#198754", "#dc3545", "#ffc107", "#6f42c1"];
                const darkThemeColors = ["#0aefff", "#00ff9c", "#39d353", "#ff073a", "#ffff00", "#ff6ec7"];


                    particlesJS('particles-js', {
                    "particles": {
                        "number": {
                            "value": 100,
                            "density": { "enable": true, "value_area": 500 }
                        },
                        "color": {
                            "value": isDarkMode ? darkThemeColors : lightThemeColors
                        },
                        "shape": {
                            "type": ["star", "circle", "triangle", "square", "polygon",  "edge"], // More shapes
                            "stroke": { "width": 1, "color": isDarkMode ? "#0aefff" : "#0d6efd" },
                            "polygon": { "nb_sides": 6 }, // Hexagon
                            "star": { "nb_sides": 5 },
                            "image": { "width": 100, "height": 100 }
                        },
                        "opacity": {
                            "value": 0.7,
                            "random": true,
                            "anim": {
                                "enable": true,
                                "speed": 2,
                                "opacity_min": 0.2,
                                "sync": false
                            }
                        },
                        "size": {
                            "value": 5,
                            "random": true,
                            "anim": { "enable": true, "speed": 5, "size_min": 0.1, "sync": false }
                        },
                        "line_linked": {
                            "enable": true,
                            "distance": 150,
                            "color": isDarkMode ? "#0aefff" : "#0d6efd", // Dynamic line color
                            "opacity": 0.5,
                            "width": 1
                        },
                        "move": {
                            "enable": true,
                            "speed": 3,
                            "direction": "none",
                            "random": true,
                            "straight": false,
                            "out_mode": "bounce",
                            "bounce": true,
                            "attract": {
                                "enable": true,
                                "rotateX": 600,
                                "rotateY": 600
                            }
                        }
                    },
                    "interactivity": {
                        "detect_on": "window",
                        "events": {
                            "onhover": { "enable": true, "mode": ["grab", "bubble"] }, // Bubble effect on hover
                            "onclick": { "enable": true, "mode": "push" },
                            "resize": true
                        },
                        "modes": {
                            "grab": {
                                "distance": 250,
                                "line_linked": {
                                    "opacity": 0.5,
                                    "color": isDarkMode ? "#00ff9c" : "#198754"
                                }
                            },
                            "bubble": {
                                "distance":300,
                                "size": 10,
                                "duration": 2,
                                "opacity": 1,
                                "speed": 3
                            },
                            "push": {
                                "particles_nb": 1
                            },
                            "repulse": {
                                "distance": 150,
                                "duration": 1.2
                            },
                            "remove": {
                                "particles_nb": 1,
                                "duration": 0.4
                            }
                        }

                    },
                    "retina_detect": true
                });
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/assets/js/notification-handler.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
    @* ===== START: ADD THIS CHAT BLOCK ===== *@
    @if (Context.Session.GetString("UserName") != null)
    {

        <div id="chat-window" class="chat-window" style="display: none;">
            <div class="chat-header">
                <div>
                    <i class="bi bi-people-fill"></i>
                    Group Chat (<span id="user-count">0</span>)
                </div>
                <div>
                    <a href="#" id="user-list-toggle" class="chat-header-icon" title="Toggle User List">
                        <i class="bi bi-person-lines-fill"></i>
                    </a>
                    <span id="chat-close" class="chat-close" title="Close Chat">&times;</span>
                </div>
            </div>

            <div class="chat-body-wrapper">

                <ul id="chat-messages" class="chat-messages"></ul>

                <ul id="online-users-list" class="online-users-list" style="display: none;">
                </ul>

            </div>
            <div id="typing-indicator" class="typing-indicator" style="display: none;"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-message-input" placeholder="Type a message..." autocomplete="off" />
                <button id="chat-send-button"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>
    }
    @* ===== END: ADD THIS CHAT BLOCK ===== *@
    @* ===== START: ADD THIS SCRIPT BLOCK ===== *@
    @if (Context.Session.GetString("UserName") != null)
    {
        <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {

                // --- Get Current User from Session (Injected by Razor) ---
                // This is secure because it's set by the server
                const currentUserName = "@Html.Raw(HttpUtility.JavaScriptStringEncode(Context.Session.GetString("UserName")))";

                // --- Get All DOM Elements ---
                const chatIcon = document.getElementById('chat-header-icon');
                const chatWindow = document.getElementById('chat-window');
                const chatClose = document.getElementById('chat-close');
                const messagesList = document.getElementById('chat-messages');
                const messageInput = document.getElementById('chat-message-input');
                const sendButton = document.getElementById('chat-send-button');

                const userListToggle = document.getElementById('user-list-toggle');
                const onlineUsersList = document.getElementById('online-users-list');
                const userCount = document.getElementById('user-count');
                const typingIndicator = document.getElementById('typing-indicator');


                const chatBadge = document.getElementById('chat-badge');
                let unreadCount = 0;
                let typingTimer;              // Timer to check when user stops typing
                let isTyping = false;         // Flag to prevent sending too many "start" events
                let typingUsers = new Set();  // A list of users who are currently typing

                // --- UI Event Listeners ---
                chatIcon.addEventListener('click', (e) => {
                    e.preventDefault(); // Stop the link from trying to navigate
                    if (chatWindow.style.display === 'none') {
                        chatWindow.style.display = 'flex';
                        scrollToBottom();

                        // --- ADD THIS TO RESET ---
                        unreadCount = 0;
                        updateBadge();
                        // --- END RESET ---

                    } else {
                        chatWindow.style.display = 'none';
                    }
                });

                 chatClose.addEventListener('click', () => {
                    chatWindow.style.display = 'none';
                });

                userListToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const isHidden = onlineUsersList.style.display === 'none';

                    onlineUsersList.style.display = isHidden ? 'block' : 'none';

                    if (isHidden) {
                        messagesList.classList.add('showing-users');
                    } else {
                        messagesList.classList.remove('showing-users');
                    }
                });

                // --- SignalR Connection ---
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl("/chatHub") // Must match the URL in Program.cs
                    .withAutomaticReconnect()
                    .build();

                // --- Helper: Add Message to UI ---
                 function appendMessage(user, message, timestamp, typeClass) {
                    const li = document.createElement('li');
                    li.classList.add(typeClass);

                    // For system messages
                    if (typeClass === 'message-system') {
                        li.textContent = message;
                    }
                    // For user messages
                    else {

                        // --- NEW: Convert timestamp ---
                        // 'timestamp' is now a full UTC date string from the server
                        const date = new Date(timestamp);

                        // This formats it to the user's local time, e.g., "10:54 AM"
                        const localTime = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                        // --- END NEW ---

                        li.innerHTML = `<span class="message-user">${user}</span>
                                      ${message}
                                      <span class="message-time">${localTime}</span>`; // <-- Use the new 'localTime' variable

                        // Style "me" vs "other"
                        if (user === currentUserName) {
                            li.classList.add('message-me');
                        } else {
                            li.classList.add('message-other');
                        }
                    }
                    messagesList.appendChild(li);
                    scrollToBottom();
                }
                function scrollToBottom() {
                    messagesList.scrollTop = messagesList.scrollHeight;
                }
                function updateBadge() {
                    if (unreadCount === 0) {
                        chatBadge.style.display = 'none';
                        chatBadge.textContent = '0';
                    } else {
                        chatBadge.style.display = 'flex'; // Use flex to center the number
                        // Show "9+" if count is too high
                        chatBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    }
                }
                function updateTypingIndicator() {
                    if (typingUsers.size === 0) {
                        // No one is typing
                        typingIndicator.textContent = "";
                        typingIndicator.style.display = "none";
                    } else if (typingUsers.size === 1) {
                        // One person is typing
                        const user = typingUsers.values().next().value; // Get the first user
                        typingIndicator.textContent = `${user} is typing...`;
                        typingIndicator.style.display = "block";
                    } else {
                        // Multiple people are typing
                        typingIndicator.textContent = "Several people are typing...";
                        typingIndicator.style.display = "block";
                    }
                }

                // --- SignalR: Receive Messages ---
                connection.on("ReceiveMessage", (user, message, timestamp) => {
                     if (chatWindow.style.display === 'none') { 
                        // Don't count our own messages (extra safeguard)
                        if (user !== currentUserName) { 
                            unreadCount++;
                            updateBadge();
                        }
                    }
                    appendMessage(user, message, timestamp, 'message-user-li');
                });

                connection.on("ReceiveSystemMessage", (message, type) => {
                    appendMessage(null, message, null, 'message-system');
                });
                connection.on("UpdateUserList", (users) => {
                    onlineUsersList.innerHTML = ""; // Clear the list
                    userCount.textContent = users.length; // Update the count in the header

                    users.forEach(user => {
                        const li = document.createElement('li');
                        li.textContent = user;

                        if (user === currentUserName) {
                            li.textContent += " (You)";
                            li.classList.add('is-you');

                        }
                        onlineUsersList.appendChild(li);
                    });
                });
                connection.on("UserIsTyping", (user) => {
                    typingUsers.add(user); // Add user to our list
                    updateTypingIndicator();
                });

                connection.on("UserStoppedTyping", (user) => {
                    typingUsers.delete(user); // Remove user from our list
                    updateTypingIndicator();
                });

                // --- SignalR: Send Message ---
                function sendMessage() {
                    const message = messageInput.value.trim();
                    if (message) {
                        // Call the "SendMessage" method on the C# ChatHub
                        connection.invoke("SendMessage", currentUserName, message)
                            .catch(err => console.error(err.toString()));

                        messageInput.value = "";
                        messageInput.focus();
                    }
                }

                sendButton.addEventListener('click', sendMessage);
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                messageInput.addEventListener('keyup', (e) => {
                    // Ignore Enter key (it's for sending)
                    if (e.key === 'Enter') return;

                    // 1. Tell server we are typing
                    if (isTyping === false) {
                        connection.invoke("NotifyStartTyping", currentUserName)
                            .catch(err => console.error(err.toString()));
                        isTyping = true;
                    }

                    // 2. Clear the "stop typing" timer
                    clearTimeout(typingTimer);

                    // 3. Set a new timer. If it finishes, we've stopped typing.
                    typingTimer = setTimeout(() => {
                        connection.invoke("NotifyStopTyping", currentUserName)
                            .catch(err => console.error(err.toString()));
                        isTyping = false;
                    }, 1500); // 1.5 seconds
                });


                // --- Start the Connection ---
                connection.start()
                    .then(() => {
                        console.log("SignalR Chat Connected.");
                        // Notify everyone that this user has joined
                        connection.invoke("RegisterUser", currentUserName)
                            .catch(err => console.error(err.toString()));
                    })
                    .catch(err => console.error('SignalR Connection Error: ', err.toString()));


            });
        </script>
    }
    @* ===== END: ADD THIS SCRIPT BLOCK ===== *@
</body>
</html>